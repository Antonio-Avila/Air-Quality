---
title: "AQS"
author: "Antonio Avila"
date: "10/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RAQSAPI)
library(keyring)
library(beepr)
library(usmap)
library(lubridate)
library(forecast)
```

## R Markdown

```{r enable AQS credentials, include = FALSE}
# key_set(service = 'AQSDatamart', username = 'aavila2802@gmail.com')

datamart_user <-  'aavila2802@gmail.com'
server <-  'AQSDatamart'
aqs_credentials(username = datamart_user, key_get(service = server, username = datamart_user))
```

```{r state codes, include = FALSE}

state_codes <- aqs_states()

```


```{r extract ozone data, include = FALSE}

# parameter 62104 is the max temp in a 24 Hr period
# parameter 62105 is the min temp in a 24 Hr period
# parameter 62106 is the temp diff in a 24 Hr period
# parameter 44201 is the ozone 
# parameter 42102 is carbon dioxide

# Working for the parameter code 45201 (benzine) but not for any other codes from the list above

# start_time = proc.time()
# ozone_texas <- aqs_sampledata_by_state(parameter = "44201",
#                                            bdate = as.Date("20200901",
#                                                            format="%Y%m%d"
#                                                            ),
#                                            edate = as.Date("20210901",
#                                                           format = "%Y%m%d"),
#                                            stateFIPS = "48"
#                                           )
# print("Time to Execute:")
# print(proc.time() - start_time)
# beep()

```



```{r import data and combine}

# ozone_texas_20_21 <- read_csv("ozone_texas_20_21.csv")
# ozone_texas_19_20 <- read_csv("ozone_texas_19_20.csv")
# ozone_texas_18_19 <- read_csv("ozone_texas_18_19.csv")
# ozone_texas_17_18 <- read_csv("ozone_texas_17_18.csv")
# 
# ozone_texas <- union(union(union(ozone_texas_17_18, ozone_texas_18_19), ozone_texas_19_20), ozone_texas_20_21)
# 
# write_csv(ozone_texas, "ozone_texas.csv")

ozone_texas <- read_csv("ozone_texas.csv")
```


```{r calculate max of rolling 8 hour ozone avg}
avg_8hr <- function(data){
  avgs = matrix(nrow = 14-8, ncol = 1)
  for(i in 1:(24-8)) { 
    avgs[i] = mean(data[i:(i+7)], na.rm = TRUE)
  }
  return(avgs)
}


max_8hr_avg <- function(avgs){
  max_avg = max(avgs)
  return(max_avg)
}


daily_max_avg <- ozone_texas %>% 
  group_by(county, site_number, date_local) %>% 
  summarize(max_8hr_avg = max_8hr_avg(sample_measurement))


```

```{r verify with published data}

test_day = ozone_texas %>% filter(site_number == '0416', date_local == '2019-04-29')

```



```{r Harris county ozone evol}

daily_max_avg %>% filter(county == "Harris") %>%
  group_by(date_local) %>% 
  summarize(avg_max = mean(max_8hr_avg, na.rm = TRUE)) %>% 
  ggplot(aes(date_local, avg_max)) + 
    geom_line() + 
    geom_hline(yintercept = 0.07, color = "red") +
    geom_smooth()


```



```{r}
ozone_texas %>% group_by(date_local) %>% 
  summarise(avg_ppb = mean(sample_measurement, na.rm = TRUE) * 1000) %>% 
  ggplot(aes(date_local, avg_ppb)) +
    geom_line() +
    geom_smooth()
```


```{r}
ozone_texas %>% group_by(county, date_local) %>% 
  summarise(avg_ppb = mean(sample_measurement, na.rm = TRUE) * 1000) %>% 
  ggplot(aes(date_local, avg_ppb, color = county)) +
    geom_line() +
    geom_smooth()
```


```{r}

# health_ozone <- data.frame()

avg_county_ozone <- ozone_texas %>% group_by(state_code, county, county_code, site_number) %>% 
  summarise(avg_ppm = mean(sample_measurement, na.rm = TRUE))


avg_county_ozone["avg_ppb"] <- avg_county_ozone["avg_ppm"] * 1000
avg_county_ozone["fips"] <- as.integer(avg_county_ozone$state_code) * 1000 + as.integer(avg_county_ozone$county_code)


plot_usmap(regions = "counties", include = "TX", data = avg_county_ozone, values = "avg_ppb") +
  scale_fill_gradient(low = "green", high = "red")

  
```




























