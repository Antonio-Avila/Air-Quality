---
title: "AQS"
author: "Antonio Avila"
date: "10/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(RAQSAPI)
library(keyring)
library(beepr)
library(usmap)
```

## R Markdown

```{r enable AQS credentials, include = FALSE}
# key_set(service = 'AQSDatamart', username = 'aavila2802@gmail.com')

datamart_user <-  'aavila2802@gmail.com'
server <-  'AQSDatamart'
aqs_credentials(username = datamart_user, key_get(service = server, username = datamart_user))
```

```{r state codes, include = FALSE}

state_codes <- aqs_states()

```


```{r extract ozone data, include = FALSE}

# parameter 62104 is the max temp in a 24 Hr period
# parameter 62105 is the min temp in a 24 Hr period
# parameter 62106 is the temp diff in a 24 Hr period
# parameter 44201 is the ozone 
# parameter 42102 is carbon dioxide

# Working for the parameter code 45201 (benzine) but not for any other codes from the list above

# start_time = proc.time()
# ozone_texas <- aqs_sampledata_by_state(parameter = "44201",
#                                            bdate = as.Date("20200901",
#                                                            format="%Y%m%d"
#                                                            ),
#                                            edate = as.Date("20210901",
#                                                           format = "%Y%m%d"),
#                                            stateFIPS = "48"
#                                           )
# print("Time to Execute:")
# print(proc.time() - start_time)
# beep()

```



```{r import data and combine}

# ozone_texas_20_21 <- read_csv("ozone_texas_20_21.csv")
# ozone_texas_19_20 <- read_csv("ozone_texas_19_20.csv")
# ozone_texas_18_19 <- read_csv("ozone_texas_18_19.csv")
# ozone_texas_17_18 <- read_csv("ozone_texas_17_18.csv")
# 
# ozone_texas <- union(union(union(ozone_texas_17_18, ozone_texas_18_19), ozone_texas_19_20), ozone_texas_20_21)
# 
# write_csv(ozone_texas, "ozone_texas.csv")

ozone_texas <- read_csv("ozone_texas.csv")
```


```{r}

```


```{r}
ozone_texas_20_21 %>% group_by(date_local) %>% 
  summarise(avg_ppb = mean(sample_measurement, na.rm = TRUE) * 1000) %>% 
  ggplot(aes(date_local, avg_ppb)) +
    geom_line() +
    geom_smooth()
```



```{r}

# health_ozone <- data.frame()

avg_county_ozone <- ozone_texas_17_18 %>% group_by(state_code, county, county_code, site_number) %>% 
  summarise(avg_ppm = mean(sample_measurement, na.rm = TRUE))


avg_county_ozone["avg_ppb"] <- avg_county_ozone["avg_ppm"] * 1000
avg_county_ozone["fips"] <- as.integer(avg_county_ozone$state_code) * 1000 + as.integer(avg_county_ozone$county_code)


plot_usmap(regions = "counties", include = "TX", data = avg_county_ozone, values = "avg_ppb") +
  scale_fill_gradient(low = "green", high = "red")


  
```




























